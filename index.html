<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptiSoft Enterprise | Distribution</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0f172a; 
            --secondary: #3b82f6; 
            --accent: #0ea5e9; 
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-light: #64748b;
            --danger: #ef4444;
            --success: #10b981;
            --border: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        aside {
            width: 260px;
            background: var(--primary);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            transition: 0.3s ease-in-out;
            z-index: 1000;
            flex-shrink: 0; 
        }

        aside.closed { margin-left: -260px; position: absolute; height: 100%; box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
        aside.open { margin-left: 0; position: absolute; height: 100%; box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
        
        @media (min-width: 900px) {
            aside { position: relative !important; margin-left: 0 !important; height: 100vh !important; box-shadow: none !important; }
            aside.closed, aside.open { position: relative !important; margin-left: 0 !important; }
            .menu-toggle { display: none !important; }
            .sidebar-overlay { display: none !important; }
        }

        .brand { font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 12px; margin-bottom: 40px; color: white; }
        
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 14px 16px; color: #94a3b8;
            text-decoration: none; border-radius: 8px; cursor: pointer; transition: 0.2s;
            margin-bottom: 5px; font-size: 14px; font-weight: 500;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: var(--secondary); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

        /* --- MAIN CONTENT --- */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; width: 100%; position: relative; }
        
        header {
            background: var(--surface); height: 70px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0;
        }

        .menu-toggle { font-size: 20px; color: var(--text-main); cursor: pointer; display: block; margin-right: 15px; }
        .search-wrapper { position: relative; width: 300px; }
        @media(max-width: 600px) { .search-wrapper { display: none; } } 

        .user-profile { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; }
        .avatar { width: 35px; height: 35px; background: var(--bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--secondary); }

        .content-area { flex: 1; padding: 20px; overflow-y: auto; overflow-x: hidden; }

        /* --- GRIDS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dashboard-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        @media(max-width: 900px) { .dashboard-layout { grid-template-columns: 1fr; } }

        .card { background: var(--surface); border-radius: 12px; padding: 20px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .stat-card h4 { font-size: 13px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .stat-card .val { font-size: 24px; font-weight: 700; color: var(--text-main); }

        /* TABLES */
        .table-container { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; } 
        th { background: #f8fafc; text-align: left; padding: 15px 20px; font-size: 13px; color: var(--text-light); font-weight: 600; text-transform: uppercase; }
        td { padding: 15px 20px; border-top: 1px solid var(--border); color: var(--text-main); font-size: 14px; }
        tr:hover td { background: #f8fafc; }
        .badge { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .badge-liq { background: #e0f2fe; color: #0284c7; }
        .badge-sol { background: #fef3c7; color: #d97706; }

        /* POS LAYOUT */
        .pos-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; height: 100%; }
        @media(max-width: 900px) { 
            .pos-layout { grid-template-columns: 1fr; display: flex; flex-direction: column; height: auto; }
            .pos-products { height: 400px; overflow-y: auto; }
        }
        .pos-products { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); padding: 20px; }
        .pos-cart { background: white; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; }
        .cart-header { padding: 20px; border-bottom: 1px solid var(--border); background: #f8fafc; border-radius: 12px 12px 0 0; }
        .cart-items { flex: 1; overflow-y: auto; padding: 10px; min-height: 200px; }
        .cart-footer { padding: 20px; border-top: 1px solid var(--border); background: #f8fafc; border-radius: 0 0 12px 12px; }
        .cart-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }

        /* FORMS */
        .btn { padding: 10px 18px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; }
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; }
        
        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; backdrop-filter: blur(2px); }
        .modal { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 12px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; display: none; }
        .sidebar-overlay.active { display: block; }
        
        .hidden { display: none !important; }
        .flex { display: flex; gap: 10px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 10px; }
        .page-title { font-size: 24px; font-weight: 700; color: var(--text-main); }
        
        /* Toast */
        .toast { position: fixed; bottom: 30px; right: 30px; background: #1e293b; color: white; padding: 12px 24px; border-radius: 8px; display: flex; align-items: center; gap: 10px; transform: translateY(100px); opacity: 0; transition: 0.3s; z-index: 3000; }
        .toast.show { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <aside id="sidebar">
        <div class="brand">
            <i class="fas fa-leaf"></i> OptiSoft <span style="font-size:10px; background:rgba(255,255,255,0.2); padding:2px 5px; border-radius:4px; margin-left:5px;">PRO</span>
        </div>
        <nav>
            <div class="nav-item active" onclick="navTo('dashboard', this); toggleSidebarMobileOnly()">
                <i class="fas fa-chart-pie"></i> Dashboard
            </div>
            <div class="nav-item" onclick="navTo('inventory', this); toggleSidebarMobileOnly()">
                <i class="fas fa-boxes"></i> Inventory Stock
            </div>
            <div class="nav-item" onclick="navTo('sales', this); toggleSidebarMobileOnly()">
                <i class="fas fa-cash-register"></i> Distribution (POS)
            </div>
            <div class="nav-item" onclick="navTo('reports', this); toggleSidebarMobileOnly()">
                <i class="fas fa-file-invoice"></i> Reports
            </div>
        </nav>
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div class="nav-item" onclick="resetSystem()" style="color: #ef4444;">
                <i class="fas fa-power-off"></i> Reset System
            </div>
        </div>
    </aside>

    <main>
        <header>
            <div style="display: flex; align-items: center;">
                <i class="fas fa-bars menu-toggle" onclick="toggleSidebar()"></i>
                <div class="search-wrapper" style="margin-left: 10px;">
                    <i class="fas fa-search" style="position: absolute; left: 10px; top: 10px; color: #94a3b8;"></i>
                    <input type="text" placeholder="Global Search..." style="width: 100%; padding: 8px 8px 8px 35px; border: 1px solid var(--border); border-radius: 6px; background: #f8fafc;">
                </div>
            </div>
            <div class="user-profile">
                <span>Admin</span>
                <div class="avatar"><i class="fas fa-user"></i></div>
            </div>
        </header>

        <div class="content-area">
            
            <div id="dashboard" class="view">
                <div class="page-header">
                    <h2 class="page-title">Executive Overview</h2>
                    <button class="btn btn-outline"><i class="fas fa-download"></i> Export</button>
                </div>

                <div class="stats-grid">
                    <div class="card stat-card">
                        <h4>Total Revenue</h4>
                        <div class="val" id="d-revenue">LKR 0.00</div>
                        <div class="stat-card .trend up"><i class="fas fa-arrow-up"></i> Real-time</div>
                    </div>
                    <div class="card stat-card">
                        <h4>Stock Valuation</h4>
                        <div class="val" id="d-valuation">LKR 0.00</div>
                        <div class="trend"><i class="fas fa-warehouse"></i> Asset Value</div>
                    </div>
                    <div class="card stat-card">
                        <h4>Active Products</h4>
                        <div class="val" id="d-products">0</div>
                        <div class="trend"><i class="fas fa-check"></i> In Catalog</div>
                    </div>
                    <div class="card stat-card">
                        <h4>Distributions</h4>
                        <div class="val" id="d-clients">0</div>
                        <div class="trend"><i class="fas fa-truck"></i> Completed</div>
                    </div>
                </div>

                <div class="dashboard-layout">
                    <div class="card" style="height: 350px;">
                        <h4 style="margin-bottom: 20px;">Sales Analytics (This Session)</h4>
                        <canvas id="salesChart"></canvas>
                    </div>
                    <div class="card">
                        <h4 style="margin-bottom: 20px;">Low Stock Alerts</h4>
                        <div id="alert-list" style="font-size: 13px; color: var(--text-light);"></div>
                    </div>
                </div>
            </div>

            <div id="inventory" class="view hidden">
                <div class="page-header">
                    <h2 class="page-title">Inventory Management</h2>
                    <button class="btn btn-primary" onclick="openModal('modal-add-item')"><i class="fas fa-plus"></i> Add Stock</button>
                </div>

                <div class="table-container">
                    <table id="inv-table">
                        <thead>
                            <tr>
                                <th>Batch</th>
                                <th>Product Name</th>
                                <th>Type</th>
                                <th>Expiry</th>
                                <th>Price (LKR)</th>
                                <th>Stock</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="inv-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="sales" class="view hidden">
                <div class="page-header">
                    <h2 class="page-title">Distribution Terminal</h2>
                </div>
                
                <div class="pos-layout">
                    <div class="pos-products">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin:0;">Product Catalog</h4>
                            <button class="btn btn-outline btn-sm" onclick="openModal('modal-add-distributor')">
                                <i class="fas fa-user-plus"></i> Manage Distributors
                            </button>
                        </div>

                        <div class="form-group">
                            <input type="text" id="pos-search" class="form-control" placeholder="Search product..." onkeyup="filterPosItems()">
                        </div>
                        <div id="pos-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-top: 15px;"></div>
                    </div>

                    <div class="pos-cart">
                        <div class="cart-header">
                            <h3>Current Cart</h3>
                        </div>
                        <div class="cart-items" id="cart-items-container">
                            <div style="text-align: center; color: #94a3b8; margin-top: 50px;">Cart is Empty</div>
                        </div>
                        <div class="cart-footer">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: 700; font-size: 18px; color: var(--secondary);">
                                <span>Total:</span>
                                <span id="cart-total">LKR 0.00</span>
                            </div>
                            <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="openCheckoutModal()">
                                <i class="fas fa-arrow-right"></i> Proceed to Distribution
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
             <div id="reports" class="view hidden">
                <div class="page-header">
                    <h2 class="page-title">Transaction History</h2>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Inv ID</th>
                                <th>Date</th>
                                <th>Distributor</th>
                                <th>Sales Rep</th>
                                <th>Total (LKR)</th>
                            </tr>
                        </thead>
                        <tbody id="sales-history-body"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <div class="modal-overlay" id="modal-add-item">
        <div class="modal">
            <div class="modal-header">
                <h3>Add Fertilizer Stock</h3>
                <i class="fas fa-times" style="cursor: pointer;" onclick="closeModal('modal-add-item')"></i>
            </div>
            <form onsubmit="addItem(event)">
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="i-name" class="form-control" required placeholder="e.g. Super Bloom Urea">
                </div>
                <div class="flex">
                    <div class="form-group" style="flex: 1;">
                        <label>Type</label>
                        <select id="i-type" class="form-control">
                            <option value="Solid">Solid (KG)</option>
                            <option value="Liquid">Liquid (Liters)</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Batch No</label>
                        <input type="text" id="i-batch" class="form-control" required placeholder="B-102">
                    </div>
                </div>
                <div class="flex">
                    <div class="form-group" style="flex: 1;">
                        <label>Expiry Date</label>
                        <input type="date" id="i-expiry" class="form-control" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Initial Qty</label>
                        <input type="number" id="i-qty" class="form-control" required min="1">
                    </div>
                </div>
                <div class="form-group">
                    <label>Unit Price (LKR)</label>
                    <input type="number" id="i-price" class="form-control" required step="0.01">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">Save to Inventory</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="modal-add-distributor">
        <div class="modal">
            <div class="modal-header">
                <h3>Register New Distributor</h3>
                <i class="fas fa-times" style="cursor: pointer;" onclick="closeModal('modal-add-distributor')"></i>
            </div>
            <form onsubmit="addDistributor(event)">
                <div class="form-group">
                    <label>Distributor / Store Name</label>
                    <input type="text" id="d-name" class="form-control" required placeholder="e.g. Kandy Agri Center">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="text" id="d-phone" class="form-control" required placeholder="077-xxxxxxx">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="d-address" class="form-control" required placeholder="Full Address">
                </div>
                <div class="form-group">
                    <label>Email (Optional)</label>
                    <input type="email" id="d-email" class="form-control">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">Register Distributor</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="modal-checkout">
        <div class="modal">
            <div class="modal-header">
                <h3>Distribution Details</h3>
                <i class="fas fa-times" style="cursor: pointer;" onclick="closeModal('modal-checkout')"></i>
            </div>
            <form onsubmit="finalizeOrder(event)">
                
                <div class="form-group">
                    <label>Select Distributor</label>
                    <div class="flex">
                        <select id="c-distributor-select" class="form-control" required style="flex:1;">
                            <option value="">-- Choose Distributor --</option>
                            </select>
                        <button type="button" class="btn btn-outline" onclick="openModal('modal-add-distributor')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Sales Person Name</label>
                    <input type="text" id="c-rep" class="form-control" required placeholder="Who handled this?">
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; font-weight: 700;">
                        <span>Final Total:</span>
                        <span id="checkout-total-display">LKR 0.00</span>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                    <i class="fas fa-check"></i> Complete Distribution
                </button>
            </form>
        </div>
    </div>

    <div id="toast" class="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toast-msg">Action Successful</span>
    </div>

    <script>
        // --- DATA LAYER ---
        const DB = {
            inventory: JSON.parse(localStorage.getItem('opti_inv')) || [],
            sales: JSON.parse(localStorage.getItem('opti_sales')) || [],
            distributors: JSON.parse(localStorage.getItem('opti_distributors')) || []
        };

        let currentCart = [];
        let salesChartInstance = null;

        // --- MOBILE UI LOGIC ---
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isClosed = sb.classList.contains('closed');
            if (isClosed) {
                sb.classList.remove('closed');
                sb.classList.add('open');
                overlay.classList.add('active');
            } else {
                sb.classList.remove('open');
                sb.classList.add('closed');
                overlay.classList.remove('active');
            }
        }
        function toggleSidebarMobileOnly() {
            if (window.innerWidth <= 900) toggleSidebar();
        }
        window.addEventListener('resize', () => {
            if(window.innerWidth > 900) {
                document.getElementById('sidebar').classList.remove('closed');
                document.getElementById('sidebar-overlay').classList.remove('active');
            } else {
                if(!document.getElementById('sidebar').classList.contains('open')) {
                    document.getElementById('sidebar').classList.add('closed');
                }
            }
        });

        // --- CORE FUNCTIONS ---
        function init() {
            if(window.innerWidth <= 900) document.getElementById('sidebar').classList.add('closed');
            renderInventory();
            renderSalesHistory();
            updateDashboard();
            renderPosGrid();
        }

        function saveDB() {
            localStorage.setItem('opti_inv', JSON.stringify(DB.inventory));
            localStorage.setItem('opti_sales', JSON.stringify(DB.sales));
            localStorage.setItem('opti_distributors', JSON.stringify(DB.distributors));
            updateDashboard();
            renderPosGrid();
        }

        // --- DISTRIBUTOR LOGIC ---
        function addDistributor(e) {
            e.preventDefault();
            const newDist = {
                id: Date.now(),
                name: document.getElementById('d-name').value,
                phone: document.getElementById('d-phone').value,
                address: document.getElementById('d-address').value,
                email: document.getElementById('d-email').value
            };
            DB.distributors.push(newDist);
            saveDB();
            closeModal('modal-add-distributor');
            e.target.reset();
            showToast('Distributor Registered!');
            
            // If checkout modal is open, refresh the list
            renderDistributorSelect(); 
        }

        function renderDistributorSelect() {
            const select = document.getElementById('c-distributor-select');
            select.innerHTML = '<option value="">-- Choose Distributor --</option>';
            DB.distributors.forEach(d => {
                select.innerHTML += `<option value="${d.id}">${d.name} (${d.phone})</option>`;
            });
        }

        // --- INVENTORY LOGIC ---
        function addItem(e) {
            e.preventDefault();
            const item = {
                id: Date.now(),
                name: document.getElementById('i-name').value,
                type: document.getElementById('i-type').value,
                batch: document.getElementById('i-batch').value,
                expiry: document.getElementById('i-expiry').value,
                qty: parseFloat(document.getElementById('i-qty').value),
                price: parseFloat(document.getElementById('i-price').value)
            };
            DB.inventory.push(item);
            saveDB();
            renderInventory();
            closeModal('modal-add-item');
            showToast(`Added ${item.name}`, 'success');
            e.target.reset();
        }

        function renderInventory() {
            const tbody = document.getElementById('inv-body');
            tbody.innerHTML = '';
            DB.inventory.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-family:monospace; color:var(--text-light);">${item.batch}</td>
                    <td><strong>${item.name}</strong></td>
                    <td><span class="badge ${item.type === 'Liquid' ? 'badge-liq' : 'badge-sol'}">${item.type}</span></td>
                    <td>${item.expiry}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.qty}</td>
                    <td><button class="btn-outline" style="padding: 5px 10px; font-size:12px;" onclick="deleteItem(${item.id})"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function deleteItem(id) {
            if(confirm('Delete this stock item permanently?')) {
                DB.inventory = DB.inventory.filter(i => i.id !== id);
                saveDB();
                renderInventory();
                showToast('Item deleted');
            }
        }

        // --- POS / CART LOGIC ---
        function renderPosGrid() {
            const grid = document.getElementById('pos-grid');
            grid.innerHTML = '';
            DB.inventory.forEach(item => {
                if(item.qty > 0) {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.cursor = 'pointer';
                    card.style.padding = '15px';
                    card.onclick = () => addToCart(item.id);
                    card.innerHTML = `
                        <div style="font-weight:600; font-size:14px; margin-bottom:5px;">${item.name}</div>
                        <div style="font-size:12px; color:var(--text-light); margin-bottom:10px;">Batch: ${item.batch}</div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:700; color:var(--secondary);">Rs ${item.price}</span>
                            <span class="badge badge-sol" style="font-size:10px;">Qty: ${item.qty}</span>
                        </div>
                    `;
                    grid.appendChild(card);
                }
            });
        }

        function addToCart(id) {
            const item = DB.inventory.find(i => i.id === id);
            const existing = currentCart.find(i => i.id === id);
            if(existing) {
                if(existing.cartQty < item.qty) existing.cartQty++;
                else showToast('Max stock reached', 'error');
            } else {
                currentCart.push({...item, cartQty: 1});
            }
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cart-items-container');
            container.innerHTML = '';
            let total = 0;
            currentCart.forEach((item, index) => {
                total += item.price * item.cartQty;
                container.innerHTML += `
                    <div class="cart-item">
                        <div>
                            <div style="font-weight:600;">${item.name}</div>
                            <div style="color:#94a3b8; font-size:11px;">${item.price} x ${item.cartQty}</div>
                        </div>
                        <div style="text-align:right;">
                            <div>${(item.price * item.cartQty).toFixed(2)}</div>
                            <i class="fas fa-minus-circle" style="color:var(--danger); cursor:pointer;" onclick="removeFromCart(${index})"></i>
                        </div>
                    </div>
                `;
            });
            if(currentCart.length === 0) container.innerHTML = '<div style="text-align: center; color: #94a3b8; margin-top: 50px;">Cart is Empty</div>';
            const totalStr = 'LKR ' + total.toFixed(2);
            document.getElementById('cart-total').innerText = totalStr;
            document.getElementById('checkout-total-display').innerText = totalStr; 
        }

        function removeFromCart(index) {
            currentCart.splice(index, 1);
            renderCart();
        }

        // --- CHECKOUT LOGIC ---
        function openCheckoutModal() {
            if(currentCart.length === 0) return showToast('Cart is empty', 'error');
            renderDistributorSelect(); // Load distributors into dropdown
            openModal('modal-checkout');
        }

        function finalizeOrder(e) {
            e.preventDefault();

            // 1. Get Selected Distributor ID
            const distId = document.getElementById('c-distributor-select').value;
            const salesRep = document.getElementById('c-rep').value;

            if(!distId) return showToast('Please select a Distributor', 'error');

            // 2. Find Distributor Details from DB
            const distributor = DB.distributors.find(d => d.id == distId);

            const totalVal = currentCart.reduce((sum, item) => sum + (item.price * item.cartQty), 0);

            // 3. Create Sale Record
            const sale = {
                id: 'INV-' + Date.now().toString().slice(-6),
                date: new Date().toLocaleDateString(),
                client: distributor.name, // Save name for display
                salesPerson: salesRep,
                fullDetails: distributor, // Store full object for records
                items: currentCart,
                total: totalVal
            };

            // 4. Update Inventory
            currentCart.forEach(cartItem => {
                const invItem = DB.inventory.find(i => i.id === cartItem.id);
                if(invItem) invItem.qty -= cartItem.cartQty;
            });

            // 5. Save & Clean Up
            DB.sales.unshift(sale); 
            saveDB();
            
            currentCart = [];
            e.target.reset(); 
            closeModal('modal-checkout');
            renderCart();
            renderInventory(); 
            showToast('Distribution Recorded Successfully!');
            renderSalesHistory();
        }

        // --- DASHBOARD & REPORTS ---
        function updateDashboard() {
            const totalRev = DB.sales.reduce((sum, s) => sum + s.total, 0);
            const stockVal = DB.inventory.reduce((sum, i) => sum + (i.price * i.qty), 0);
            
            document.getElementById('d-revenue').innerText = 'LKR ' + totalRev.toLocaleString();
            document.getElementById('d-valuation').innerText = 'LKR ' + stockVal.toLocaleString();
            document.getElementById('d-products').innerText = DB.inventory.length;
            document.getElementById('d-clients').innerText = DB.sales.length;

            const alerts = document.getElementById('alert-list');
            const lowItems = DB.inventory.filter(i => i.qty < 10);
            alerts.innerHTML = '';
            if(lowItems.length === 0) {
                 alerts.innerHTML = '<div style="padding: 10px; background: #ecfdf5; color: #047857; border-radius: 6px;">All stock levels optimal.</div>';
            } else {
                lowItems.forEach(i => {
                    alerts.innerHTML += `<div style="padding: 10px; background: #fff1f2; color: #be123c; border-radius: 6px; margin-bottom: 5px; font-weight:500;">Low Stock: ${i.name} (${i.qty} left)</div>`;
                });
            }
            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            const dataMap = {};
            DB.sales.forEach(s => { dataMap[s.date] = (dataMap[s.date] || 0) + s.total; });
            const labels = Object.keys(dataMap).slice(-7);
            const data = Object.values(dataMap).slice(-7);

            if(salesChartInstance) salesChartInstance.destroy();
            salesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.length ? labels : ['Today'],
                    datasets: [{
                        label: 'Sales (LKR)',
                        data: data.length ? data : [0],
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderSalesHistory() {
            const tbody = document.getElementById('sales-history-body');
            tbody.innerHTML = '';
            DB.sales.forEach(sale => {
                tbody.innerHTML += `
                    <tr>
                        <td>${sale.id}</td>
                        <td>${sale.date}</td>
                        <td>
                            <div>${sale.client}</div>
                            <div style="font-size:11px; color:#64748b;">${sale.fullDetails?.phone || ''}</div>
                        </td>
                        <td>${sale.salesPerson || '-'}</td>
                        <td><strong>LKR ${sale.total.toFixed(2)}</strong></td>
                    </tr>
                `;
            });
        }

        // --- UX UTILS ---
        function navTo(id, el) {
            document.querySelectorAll('.view').forEach(d => d.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function resetSystem() {
            if(confirm('FULL FACTORY RESET: This will wipe all data. Continue?')) {
                localStorage.clear();
                location.reload();
            }
        }
        
        function filterPosItems() {
             const term = document.getElementById('pos-search').value.toLowerCase();
             const grid = document.getElementById('pos-grid');
             const cards = grid.getElementsByClassName('card');
             Array.from(cards).forEach(card => {
                 const text = card.innerText.toLowerCase();
                 card.style.display = text.includes(term) ? 'block' : 'none';
             });
        }

        init();
    </script>
</body>
</html>
